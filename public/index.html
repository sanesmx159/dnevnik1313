<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –¥–Ω–µ–≤–Ω–∏–∫ ‚Äî –æ–Ω–ª–∞–π–Ω</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background-color: #fafafa; }
  h1 { margin-bottom: 10px }
  .top { margin-bottom: 12px }
  button { padding: 8px 12px; margin-right:8px; border-radius: 6px; border:1px solid #888; background:#f1f1f1; cursor:pointer }
  .tabs { display:flex; flex-wrap:wrap; border-bottom:2px solid #ccc; margin-bottom:10px }
  .tab { padding:8px 12px; cursor:pointer; border:1px solid #ccc; border-bottom:none; background:#f1f1f1; margin-right:4px; border-radius:6px 6px 0 0 }
  .tab.active { background:white; font-weight:bold }
  .tabContent { display:none }
  .tabContent.active { display:block }
  table { border-collapse:collapse; width:100%; background:white }
  th,td { border:1px solid #ccc; padding:6px; min-width:50px; text-align:center }
  input[type=number]{ width:50px }
</style>
</head>
<body>
  <h1>üìò –≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –¥–Ω–µ–≤–Ω–∏–∫ (–æ–Ω–ª–∞–π–Ω)</h1>
  <div class="top">
    <button onclick="showLogin()">–í–æ–π—Ç–∏ –∫–∞–∫ —É—á–∏—Ç–µ–ª—å</button>
    <button id="saveBtn" onclick="saveAll()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä</button>
    <button onclick="loadAll()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å —Å–µ—Ä–≤–µ—Ä–∞</button>
  </div>

  <div class="tabs" id="tabsContainer"></div>

  <div id="contentContainer"></div>

<script>
const subjects = [
  {id:'bilelit', label:'–ë–µ–ª.–ª–∏—Ç'},
  {id:'belyaz', label:'–ë–µ–ª.—è–∑'},
  {id:'russlit', label:'–†—É—Å—Å–∫.–ª–∏—Ç'},
  {id:'russya', label:'–†—É—Å—Å–∫.—è–∑'},
  {id:'matem', label:'–ú–∞—Ç–µ–º'},
  {id:'fizika', label:'–§–∏–∑–∏–∫–∞'},
  {id:'biologiya', label:'–ë–∏–æ–ª–æ–≥–∏—è'},
  {id:'belist', label:'–ë–µ–ª.–∏—Å—Ç'},
  {id:'vsemist', label:'–í—Å–µ–º.–∏—Å—Ç'},
  {id:'franc', label:'–§—Ä–∞–Ω—Ü.—è–∑'},
  {id:'inform', label:'–ò–Ω—Ñ–æ—Ä–º'},
  {id:'trud', label:'–¢—Ä—É–¥'}
];
const totalRows = 29;
const totalCols = 60;
let teacherMode = false;
let gradesData = { subjects: {} };

// –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—ë–º –≤–∫–ª–∞–¥–∫–∏ –∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
const tabsContainer = document.getElementById('tabsContainer');
const contentContainer = document.getElementById('contentContainer');

subjects.forEach((s, idx) => {
  const tab = document.createElement('div');
  tab.className = 'tab' + (idx === 0 ? ' active' : '');
  tab.textContent = s.label;
  tab.onclick = (e) => openTab(e, s.id);
  tabsContainer.appendChild(tab);

  const content = document.createElement('div');
  content.id = s.id;
  content.className = 'tabContent' + (idx === 0 ? ' active' : '');
  const h = document.createElement('h2');
  h.textContent = s.label;
  content.appendChild(h);
  const wrap = document.createElement('div');
  wrap.style.overflowX = 'auto';
  const table = document.createElement('table');
  const thead = document.createElement('thead');
  const headerRow = document.createElement('tr');
  const thNum = document.createElement('th'); thNum.textContent = '‚Ññ'; headerRow.appendChild(thNum);
  for (let i=2;i<=totalCols;i++){ const th=document.createElement('th'); headerRow.appendChild(th); }
  thead.appendChild(headerRow); table.appendChild(thead);
  const tbody = document.createElement('tbody');
  for (let r=1;r<=totalRows;r++){
    const tr = document.createElement('tr');
    const tdNum = document.createElement('td'); tdNum.textContent = r; tr.appendChild(tdNum);
    for (let c=2;c<=totalCols;c++){
      const td=document.createElement('td');
      const input=document.createElement('input'); input.type='number'; input.min='1'; input.max='5';
      input.id=`${s.id}_grade_${r}_${c}`; input.disabled=true;
      td.appendChild(input); tr.appendChild(td);
    }
    tbody.appendChild(tr);
  }
  table.appendChild(tbody); wrap.appendChild(table); content.appendChild(wrap);
  contentContainer.appendChild(content);
});

function openTab(evt, id){
  document.querySelectorAll('.tabContent').forEach(el=>el.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(el=>el.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  evt.currentTarget.classList.add('active');
}

function showLogin(){
  const pwd = prompt('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å —É—á–∏—Ç–µ–ª—è:');
  if(pwd === '1324576800'){
    teacherMode = true; document.querySelectorAll('input').forEach(i=>i.disabled=false);
    alert('–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ —É—á–∏—Ç–µ–ª—å');
  } else alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
}

async function loadAll(){
  try{
    const res = await fetch('/api/grades');
    if(!res.ok) throw new Error('–û—à–∏–±–∫–∞ '+res.status);
    gradesData = await res.json();
    // –∑–∞–ø–æ–ª–Ω–∏–º —Ç–∞–±–ª–∏—Ü—ã
    for(const s of subjects){
      const subjArr = gradesData.subjects[s.id] || [];
      for(let r=1;r<=totalRows;r++){
        for(let c=2;c<=totalCols;c++){
          const input = document.getElementById(`${s.id}_grade_${r}_${c}`);
          if(!input) continue;
          input.value = subjArr[r-1]?.[c-2] ?? '';
        }
      }
    }
    alert('–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã —Å —Å–µ—Ä–≤–µ—Ä–∞');
  }catch(err){console.error(err); alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: '+err.message)}
}

async function saveAll(){
  if(!teacherMode) return alert('–¢–æ–ª—å–∫–æ —É—á–∏—Ç–µ–ª—å –º–æ–∂–µ—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å');
  // –°–æ–±–µ—Ä—ë–º –¥–∞–Ω–Ω—ã–µ
  const record = { subjects: {} };
  for(const s of subjects){
    record.subjects[s.id] = [];
    for(let r=1;r<=totalRows;r++){
      const row = [];
      for(let c=2;c<=totalCols;c++){
        const input = document.getElementById(`${s.id}_grade_${r}_${c}`);
        row.push(input ? (input.value || '') : '');
      }
      record.subjects[s.id].push(row);
    }
  }
  try{
    const pwd = prompt('–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å —É—á–∏—Ç–µ–ª—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:');
    const res = await fetch('/api/grades',{
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ password: pwd, record })
    });
    const data = await res.json();
    if(!res.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
    alert('–û—Ü–µ–Ω–∫–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ');
  }catch(err){console.error(err); alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: '+err.message)}
}

// –ó–∞–≥—Ä—É–∑–∏–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
loadAll();
</script>
</body>
</html>
